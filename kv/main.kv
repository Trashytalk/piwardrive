#:import dp kivy.metrics.dp
#:import Graph kivy_garden.graph.Graph
#:import _ localization._
#:import FadeTransition kivy.uix.screenmanager.FadeTransition
#:import MDCard kivymd.uix.card.MDCard


<MDLabel>:
    font_name: 'Roboto'
    font_size: app.ui_font_size

<Label>:
    font_name: 'Roboto'
    font_size: app.ui_font_size

<Separator@Widget>:
    size_hint_y: None
    height: dp(1)
    canvas:
        Color:
            rgba: .7, .7, .7, 1
        Rectangle:
            pos: self.pos
            size: self.size

<NavigationButton@MDRaisedButton>:
    size_hint_x: 1

# Root layout: dynamic top nav, screens, bottom diagnostics
BoxLayout:
    orientation: 'vertical'

    # Top navigation bar (buttons only added via main.py)
    MDBoxLayout:
        id: nav_bar
        orientation: 'horizontal'
        size_hint_y: None
        height: dp(48)
        spacing: dp(4)

    # Main screens area
    ScreenManager:
        id: sm
        transition: FadeTransition(duration=0.3)
        MapScreen:
            name: 'Map'
        StatsScreen:
            name: 'Stats'
        SplitScreen:
            name: 'Split'
        ConsoleScreen:
            name: 'Console'
        SettingsScreen:
            name: 'Settings'
        DashboardScreen:
            name: 'Dashboard'

    # Persistent diagnostics panel
    MDBoxLayout:
        id: diagnostics_bar
        orientation: 'horizontal'
        size_hint_y: None
        height: dp(24)
        spacing: dp(8)
        padding: dp(8), dp(4)

        MDLabel:
            id: cpu_label
            text: f'{_("cpu")}: {_("not_available")}'
            size_hint_x: 1
            halign: 'center'
        MDLabel:
            id: mem_label
            text: f'{_("mem")}: {_("not_available")}'
            size_hint_x: 1
            halign: 'center'
        MDLabel:
            id: disk_label
            text: f'{_("ssd")}: {_("not_available")}'
            size_hint_x: 1
            halign: 'center'

# Stats Screen layout
<StatsScreen>:
    ScrollView:
        do_scroll_x: False
        do_scroll_y: True
        MDGridLayout:
            cols: 3
            adaptive_height: True
            padding: dp(8)
            spacing: dp(8)

            # System & Storage
            MDCard:
                orientation: 'vertical'
                padding: dp(8)
                radius: [8]
                size_hint_y: None
                height: self.minimum_height

                MDLabel:
                    text: _("system")
                    font_style: 'H5'
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: cpu_temp_label
                    text: f"{_('cpu_temp')}: {_('not_available')}Â°C"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: cpu_load_label
                    text: f"{_('cpu_load')}: {_('not_available')}%"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: mem_usage_label
                    text: f"{_('memory_usage')}: {_('not_available')}%"
                    size_hint_y: None
                    height: self.texture_size[1]
                Separator:
                MDLabel:
                    text: _("storage")
                    font_style: 'H6'
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: disk_usage_label
                    text: f"{_('disk_usage')}: {_('not_available')}%"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: disk_health_label
                    text: f"{_('ssd_health')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: ssd_iops_label
                    text: f"{_('ssd_iops')}: {_('not_available')} ops/s"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: inode_free_label
                    text: f"{_('free_inodes')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]

            # Network & GPS
            MDCard:
                orientation: 'vertical'
                padding: dp(8)
                radius: [8]
                size_hint_y: None
                height: self.minimum_height

                MDLabel:
                    text: _("network_gps")
                    font_style: 'H5'
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: kismet_count_label
                    text: f"{_('aps')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: bettercap_count_label
                    text: f"{_('handshakes')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: gps_accuracy_label
                    text: f"{_('accuracy')}: {_('not_available')} m"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: gps_fix_label
                    text: f"{_('fix')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]

            # Graph & Services
            MDCard:
                orientation: 'vertical'
                padding: dp(8)
                radius: [8]
                size_hint_y: None
                height: self.minimum_height

                Graph:
                    id: cpu_graph
                    xlabel: _("time")
                    ylabel: _("load")
                    x_ticks_minor: 5
                    x_grid: True
                    y_grid: True
                    size_hint_y: None
                    height: dp(200)
                Separator:
                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height

                    MDLabel:
                        id: kismet_status_label
                        text: f"{_('kismet')}: {_('not_available')}"
                        halign: 'left'
                    MDLabel:
                        id: bettercap_status_label
                        text: f"{_('bettercap')}: {_('not_available')}"
                        halign: 'left'

# Split Screen layout
<SplitScreen>:
    BoxLayout:
        orientation: 'horizontal'

        # Left: Map view
        MapView:
            id: split_mapview
            size_hint_x: 0.66

        # Right: Metrics column
        ScrollView:
            size_hint_x: 0.34

            MDBoxLayout:
                orientation: 'vertical'
                padding: dp(8)
                spacing: dp(4)
                size_hint_y: None
                height: self.minimum_height

                MDLabel:
                    id: split_cpu_label
                    text: f"{_('cpu')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: split_bssid_label
                    text: f"{_('bssids')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: split_handshake_label
                    text: f"{_('handshakes')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: split_rssi_label
                    text: f"{_('avg_rssi')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]

                Separator:

                MDLabel:
                    id: split_kismet_uptime_label
                    text: f"{_('kismet')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: split_bettercap_uptime_label
                    text: f"{_('bettercap')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]
                MDLabel:
                    id: split_fix_quality_label
                    text: f"{_('fix')}: {_('not_available')}"
                    size_hint_y: None
                    height: self.texture_size[1]

# Console Screen layout
<ConsoleScreen>:
    LogViewer:
        id: console_log
        size_hint_y: 1
        size_hint_x: 1
        log_path: '/var/log/syslog'
# Map Screen layout
<MapScreen>:
    BoxLayout:
        orientation: 'vertical'
        MDBoxLayout:
            id: filter_bar
            size_hint_y: None
            height: dp(48)
            spacing: dp(4)
            padding: dp(4)
            MDTextField:
                id: ssid_filter
                hint_text: 'SSID'
                size_hint_x: 0.25
            MDTextField:
                id: enc_filter
                hint_text: 'Encryption'
                size_hint_x: 0.25
            MDTextField:
                id: oui_filter
                hint_text: 'Vendor OUI'
                size_hint_x: 0.25
            MDRaisedButton:
                text: 'Apply'
                size_hint_x: 0.12
                on_release: root.filter_ap_markers(ssid_filter.text or None, enc_filter.text or None, oui_filter.text or None)
            MDRaisedButton:
                text: 'Clear'
                size_hint_x: 0.13
                on_release:
                    ssid_filter.text = ''
                    enc_filter.text = ''
                    oui_filter.text = ''
                    root.filter_ap_markers()
            MDRaisedButton:
                id: follow_btn
                text: 'Follow ON' if app.map_follow_gps else 'Follow OFF'
                size_hint_x: 0.18
                on_release: root.toggle_follow()
        MapView:
            id: mapview
            on_touch_down: root._map_touch_down(self, args[1])
            on_touch_move: root._map_touch_move(self, args[1])
            on_touch_up: root._map_touch_up(self, args[1])
